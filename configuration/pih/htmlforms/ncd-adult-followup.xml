<htmlform id="liberia-ncd-followup" class="simple-form-ui"
          formUuid="8b0fb553-c59b-42c0-8d5d-1f90c04d1c02"
          formEncounterType="5cbfd6a2-92d9-4ad0-b526-9d29bfe1d10c"
          formName="NCD Followup" formVersion="1.0">

    <redirectOnSave url="/pihcore/visit/visit.page?patient={{patient.id}}&amp;encounter={{encounter.id}}#/overview"/>

    <postSubmissionAction class="org.openmrs.module.pihcore.htmlformentry.action.CleanDiagnosisConstructAction"/>
    <postSubmissionAction class="org.openmrs.module.pihcore.htmlformentry.action.CleanPrescriptionConstructAction"/>

    <macros>
        <macro key="pt_has_htn" expression="conditionListConcepts.contains($fn.getConcept('PIH:HYPERTENSION'))"/>
        <macro key="pt_has_dbt" expression="conditionListConcepts.contains($fn.getConcept('PIH:DIABETES'))"/>
        <macro key="pt_has_rf" expression="conditionListConcepts.contains($fn.getConcept('PIH:RENAL FAILURE'))"/>
        <macro key="pt_has_asthma" expression="conditionListConcepts.contains($fn.getConcept('PIH:ASTHMA'))"/>
        <macro key="pt_has_copd"
               expression="conditionListConcepts.contains($fn.getConcept('PIH:CHRONIC OBSTRUCTIVE PULMONARY DISEASE'))"/>
        <macro key="pt_has_hf" expression="conditionListConcepts.contains($fn.getConcept('PIH:HEART FAILURE'))"/>
        <macro key="pt_has_lf" expression="conditionListConcepts.contains($fn.getConcept('PIH:LIVER FAILURE'))"/>
        <macro key="pt_has_scd" expression="conditionListConcepts.contains($fn.getConcept('PIH:SPLENOMEGALY'))"/>
    </macros>

    <!-- ToDo:  Use messages.properties -->
    <translations defaultLocale="fr">
        <code name="yes">
            <variant locale="en" value="yes"/>
            <variant locale="fr" value="oui"/>
        </code>
        <code name="no">
            <variant locale="en" value="no"/>
            <variant locale="fr" value="non"/>
        </code>
    </translations>

    <style type="text/css">

        #who-when-where {
        margin-bottom: 6px;
        border-bottom: 1px solid #ccc;
        }

        #who-when-where p {
        display: inline-block;
        padding-right: 20px;
        }

        #where > input[type=text] {
        display: inline-block;
        }

        .narrow {
        width: 200px;
        }

        .field-error {
        color: #ff6666;
        font-size: 1.1em;
        display: block;
        }

        .two-columns {
        column-count: 2;
        -webkit-column-count: 2;
        -moz-column-count: 2;
        padding: 10px;
        margin-left: 20px;
        margin-top: 30px;
        margin-bottom: 20px;
        display: block;
        }

        .simple-form-ui input {
        min-width: 80%
        }

        form fieldset {
        min-width: 90%;
        display: block;
        }

        #calculated-waist-hip-ratio {
        font-weight: bold;
        font-size: 1.4em;
        }

        .encounter-summary-container #calculated-ratio {
        font-size: 1em;
        font-weight: normal;
        }

        #encounterDate input {
        min-width: 15%
        }

        .half-size-text {
        color: #ff6666;
        font-size: 50%;
        display: block;
        }

        .section-container {
        background: #F2F2F2;
        box-shadow: 3px 3px 3px 1px rgba(0, 0, 0, 0.2);
        padding: 10px 5px 10px 15px;
        line-height: 1.5em; /*add this for vertical spacing between elements*/
        }

        .section-container input[type="checkbox"] {
        margin: 0px 5px; /*changed values to vertical, horizontal*/
        top:5px; /*added to offset the checkbox position to line up*/
        }

        .section-container label { /*new definition to override labels inside section-containers*/
        margin: 0px;
        }

        - .section {
        width: 95%;
        }

        textarea {
        width: 95%;
        }

        ul.copd {
        list-style-position: outside;
        }

        .list-inline label, .list-inline input[type="radio"], .list-inline span{
        display: inline-block;
        float: none;
        }

        input[type='text'], input[type='text']:focus {
        border: 0;
        border-bottom: 1px solid #DDD;
        }

        input[type='text']:focus {
        outline: none;
        }

    </style>

    <ifMode mode="VIEW">
        <style type="text/css">
            .collapsible {
            display: block !important;
            }

            .collapsible-inline {
            display: inline-block !important;
            }

            .icon-arrow-down, .icon-arrow-up {
            display: none;
            }
        </style>
    </ifMode>


    <script type="text/javascript">
        var calculateWaistHipRatio = function(waist, hip) {
        var waistHipRatio = null;
        if (waist &amp;&amp; hip) {
        waistHipRatio = waist / hip;
        }
        return waistHipRatio;
        }

        jq(function () {
        var x =<lookup complexExpression="$allConditionsJson"/>;
        console.log(x);
        });
    </script>

    <ifMode mode="VIEW" include="false">
        <script type="text/javascript">

            jq(function () {
            // functions to handle updating the waist/hip ratio when in ENTER mode
            var updateWaistHipRatio = function () {

            var waist = htmlForm.getValueIfLegal('waist_cm.value');
            var hip = htmlForm.getValueIfLegal('hip_cm.value');

            var waistHipRatio = calculateWaistHipRatio(waist, hip);

            if (waistHipRatio != null &amp;&amp; !isNaN(waistHipRatio)) {
            jq('#calculated-waist-hip-ratio').html(waistHipRatio.toFixed(2));
            }
            else {
            jq('#calculated-waist-hip-ratio').html("");
            }
            };

            getField('waist_cm.value').change(updateWaistHipRatio);
            getField('hip_cm.value').change(updateWaistHipRatio);

            updateWaistHipRatio();

            });

        </script>
    </ifMode>


    <ifMode mode="VIEW">
        <script type="text/javascript">

            // handle displaying the waist/hip ratio when in VIEW mode
            jq(function() {

            // we have to iterate through in case there are multiple NCD forms
            // displayed on a single page

            jq('htmlform').each(function(index, form) {
            var waist = jq(form).find('#waist_cm').find('.value').text();
            var hip = jq(form).find('#hip_cm').find('.value').text();

            var waistHipRatio = calculateWaistHipRatio(waist, hip);

            if (waistHipRatio != null &amp;&amp; !isNaN(waistHipRatio)) {
            jq(form).find('#calculated-waist-hip-ratio').html(waistHipRatio.toFixed(2));
            }
            });
            });

        </script>
    </ifMode>


    <div class="htmlform">

        <ifMode mode="VIEW" include="false">
            <h2>
                <uimessage code="ui.i18n.EncounterType.name.5cbfd6a2-92d9-4ad0-b526-9d29bfe1d10c"/>
            </h2>

            <!-- users with retroConsultNote privilege can edit provider, location, and date for both retro and active visits -->
            <includeIf velocityTest="$user.hasPrivilege('Task: emr.retroConsultNote')">
                <div id="who-when-where">
                    <p id="who">
                        <label>
                            <uimessage code="emr.patientDashBoard.providerRequired"/>
                        </label>
                        <span>
                            <encounterProviderAndRole default="currentUser"
                                                      encounterRole="4f10ad1a-ec49-48df-98c7-1391c6ac7f05"
                                                      required="true"/>
                        </span>
                    </p>
                    <p id="where">
                        <label>
                            <uimessage code="emr.locationRequired"/>
                        </label>
                        <span>
                            <encounterLocation default="SessionAttribute:emrContext.sessionLocationId"
                                               tags="Consult Note Location"/>
                        </span>
                    </p>
                    <p id="when">
                        <label>
                            <uimessage code="emr.patientDashBoard.date"/>
                        </label>
                        <span>
                            <encounterDate id="encounterDate" default="now"/>
                        </span>
                    </p>
                </div>
            </includeIf>
            <!-- users with retroConsultNoteThisProviderOnly can edit location and date (but not provider) for retro visits -->
            <includeIf
                    velocityTest="$user.hasPrivilege('Task: emr.retroConsultNoteThisProviderOnly') and !($user.hasPrivilege('Task: emr.retroConsultNote')) and (!$visit.open)">
                <div style="display:none">
                    <encounterProviderAndRole default="currentUser" encounterRole="4f10ad1a-ec49-48df-98c7-1391c6ac7f05"
                                              required="true"/>
                </div>

                <div id="who-when-where">
                    <p id="who">
                        <label>
                            <uimessage code="emr.patientDashBoard.provider"/>
                        </label>
                        <span>
                            <lookup expression="user.person.personName"/>
                        </span>
                    </p>
                    <p id="where">
                        <label>
                            <uimessage code="emr.locationRequired"/>
                        </label>
                        <span>
                            <encounterLocation default="SessionAttribute:emrContext.sessionLocationId"
                                               tags="Consult Note Location"/>
                        </span>
                    </p>
                    <p id="when">
                        <label>
                            <uimessage code="emr.patientDashBoard.date"/>
                        </label>
                        <span>
                            <encounterDate id="encounterDate" default="now"/>
                        </span>
                    </p>
                </div>

            </includeIf>
            <!-- all users that don't have retroConsultNote privilege cannot edit provider, location or date when active visit -->
            <includeIf velocityTest="(!$user.hasPrivilege('Task: emr.retroConsultNote')) and ($visit.open)">
                <div style="display:none">
                    <encounterProviderAndRole default="currentUser" encounterRole="4f10ad1a-ec49-48df-98c7-1391c6ac7f05"
                                              required="true"/>
                    <encounterLocation default="SessionAttribute:emrContext.sessionLocationId"/>
                    <encounterDate id="encounterDate" default="now"/>
                </div>
                <div id="who-when-where">
                    <table id="who-where-when-view">
                        <tr>
                            <td>
                                <label>
                                    <uimessage code="emr.patientDashBoard.provider"/>
                                </label>
                                <span>
                                    <lookup complexExpression="#if($encounter) $ui.format($encounter.provider) #else $ui.format($user.person) #end"/>
                                </span>
                            </td>
                            <td>
                                <label>
                                    <uimessage code="emr.location"/>
                                </label>
                                <span>
                                    <lookup complexExpression="#if($encounter) $ui.format($encounter.location) #else $ui.format($sessionContext.sessionLocation) #end"/>
                                </span>
                            </td>
                            <td>
                                <label>
                                    <uimessage code="emr.patientDashBoard.date"/>
                                </label>
                                <span>
                                    <lookup complexExpression="#if($encounter) $ui.format($fn.startOfDay($encounter.encounterDatetime)) #else $ui.format($fn.startOfDay($formGeneratedDatetime)) #end"/>
                                </span>
                            </td>
                        </tr>
                    </table>
                </div>
            </includeIf>
        </ifMode>

        <div class="print-form-datestamps" style="display:none">
            <p><uimessage code="created_on"/>:
                <lookup complexExpression="$form.dateCreated"/>
            </p>
            <p><uimessage code="last_updated_on"/>:
                <lookup complexExpression="$form.dateChanged"/>
            </p>
            <p><uimessage code="printed_on"/>:
                <lookup complexExpression="$formGeneratedDatetime"/>
            </p>
        </div>


        <section id="ncd_vitals" sectionTag="fieldset" headerTag="legend" headerStyle="title"
                 headerCode="pihcore.ncd.vitals">
            <div class="section-container">
                <div class="two-columns">
                    <p>
                        <label>
                            <uimessage code="pihcore.ncd.vitals.waist_cm"/>
                            (<uimessage code="pihcore.ncd.vitals.waist_cm.instructions"/>)
                        </label>
                        <span class="small">
                            <obs conceptId="CIEL:163080" id="waist_cm" showUnits="true"/>
                        </span>
                    </p>

                    <p>
                        <label>
                            <uimessage code="pihcore.ncd.vitals.hip_cm"/>
                        </label>
                        <span class="small">
                            <obs conceptId="CIEL:163081" id="hip_cm" showUnits="true"/>
                        </span>
                    </p>
                </div>

                <p>
                    <span id="calculated-ratio-wrapper">
                        <uimessage code="pihcore.ncd.vitals.waist_hip_ratio"/>
                        <uimessage code="pihcore.ncd.vitals.waist_hip_ratio.comment"/>:
                        <span id='calculated-waist-hip-ratio'>
                        </span>
                    </span>
                </p>
            </div>
        </section>


        <includeIf
                velocityTest="$pt_has_htn or $pt_has_dbt or $pt_has_rf or $pt_has_asthma or $pt_has_copd or $pt_has_hf or $pt_has_lf or $pt_has_scd">
            <section sectionTag="fieldset" headerTag="legend" headerStyle="title"
                     headerCode="pihcore.ncd.title">
                <div class="section-container">
                    <div class="two-columns">
                        <!-- ToDo:  UHM-3617 Add risk calculations for hypertension -->
                        <h5>
                            <uimessage code="pihcore.ncd.last.visit.label"></uimessage>:
                        </h5>

                        <includeIf velocityTest="$pt_has_htn">
                            <obs conceptId="PIH:Disease requiring hospitalization since last visit"
                                 answerConceptId="PIH:HYPERTENSION" labelText="Hospitalized for HTN" answerLabel=""/>
                        </includeIf>

                        <includeIf velocityTest="$pt_has_dbt">
                            <obs conceptId="PIH:Disease requiring hospitalization since last visit"
                                 answerConceptId="PIH:DIABETES" labelText="Hospitalized for Diabetes" answerLabel=""/>
                        </includeIf>

                        <includeIf velocityTest="$pt_has_rf">
                            <obs conceptId="PIH:Disease requiring hospitalization since last visit"
                                 answerConceptId="PIH:RENAL FAILURE" labelText="Hospitalized for CKD" answerLabel=""/>
                        </includeIf>

                        <includeIf velocityTest="$pt_has_asthma">
                            <obs conceptId="PIH:Disease requiring hospitalization since last visit"
                                 answerConceptId="PIH:ASTHMA" labelText="Hospitalized for Asthma" answerLabel=""/>
                        </includeIf>

                        <includeIf velocityTest="$pt_has_copd">
                            <obs conceptId="PIH:Disease requiring hospitalization since last visit"
                                 answerConceptId="PIH:CHRONIC OBSTRUCTIVE PULMONARY DISEASE"
                                 labelText="Hospitalized for COPD" answerLabel=""/>
                        </includeIf>

                        <includeIf velocityTest="$pt_has_hf">
                            <obs conceptId="PIH:Disease requiring hospitalization since last visit"
                                 answerConceptId="PIH:HEART FAILURE" labelText="Hospitalized for CHF" answerLabel=""/>
                        </includeIf>

                        <includeIf velocityTest="$pt_has_lf">
                            <obs conceptId="PIH:Disease requiring hospitalization since last visit"
                                 answerConceptId="PIH:LIVER FAILURE" labelText="Hospitalized for Cirrhosis"
                                 answerLabel=""/>
                        </includeIf>

                        <includeIf velocityTest="$pt_has_scd">
                            <obs conceptId="PIH:Disease requiring hospitalization since last visit"
                                 answerConceptId="PIH:scd" labelText="Hospitalized for SCD" answerLabel=""/>
                        </includeIf>

                        <repeat>
                            <template>
                                <includeIf velocityTest="{expression}">
                                    <obsgroup groupingConceptId="PIH:12389">
                                        <obs conceptId="CIEL:1728"
                                             answerConceptId="{concept}"
                                             style="checkbox"
                                             labelText="{label}"
                                             answerLabel=""
                                             toggle="{id: '{name}-htn-dx-ynu', style: 'hide'}"/>
                                        <br/>
                                        <span class="list-inline" id="{name}-htn-dx-ynu">
                                            <obs conceptId="CIEL:1729"
                                                 answerConceptIds="PIH:YES,PIH:NO,PIH:UNKNOWN" style="radio"/>
                                            <br/>
                                            <br/>
                                        </span>
                                    </obsgroup>
                                </includeIf>
                            </template>

                            <render concept="CIEL:70468" name="alcohol" label="Drink alcohol"
                                    expression="$pt_has_htn or $pt_has_dbt or $pt_has_hf or $pt_has_lf"/>
                            <render concept="PIH:2545" name="tobacco" label="Smoke tobacco"
                                    expression="$pt_has_htn or $pt_has_dbt or $pt_has_rf or $pt_has_hf"/>
                            <render concept="CIEL:165585" name="poor-diet-adherance" label="Poor diet adherence"
                                    expression="$pt_has_htn or $pt_has_dbt or $pt_has_hf or $pt_has_lf"/>
                            <render concept="CIEL:165569" name="poor-physical-activity" label="Poor physical activity"
                                    expression="$pt_has_htn or $pt_has_dbt"/>
                            <render concept="PIH:SHORTNESS OF BREATH WITH EXERTION" name="sob"
                                    label="Shortness of breadth with exertion" expression="$pt_has_htn or $pt_has_dbt"/>
                            <render concept="PIH:Currently taking medication" name="taking-meds"
                                    label="Currently taking medications"
                                    expression="$pt_has_htn or $pt_has_dbt or $pt_has_rf or $pt_has_lf"/>
                            <render concept="PIH:HYPOGLYCEMIA" name="Hypoglycemia" label="Hypoglycemia"
                                    expression="$pt_has_htn or $pt_has_dbt"/>
                            <render concept="PIH:HEADACHE" name="Headache" label="Headache"
                                    expression="$pt_has_htn or $pt_has_dbt"/>
                            <render concept="PIH:CHEST PAIN" name="chest-pain" label="Chest pain"
                                    expression="$pt_has_htn or $pt_has_dbt"/>
                            <render concept="PIH:DIZZINESS" name="dizziness" label="Dizziness"
                                    expression="$pt_has_htn or $pt_has_dbt"/>
                            <render concept="PIH:Vision problem" name="vision" label="Vision changes"
                                    expression="$pt_has_htn or $pt_has_dbt"/>
                            <render concept="PIH:PERIPHERAL NEUROPATHY" name="neuropathy" label="Neuropathy"
                                    expression="$pt_has_htn or $pt_has_dbt"/>
                            <render concept="PIH:Ulcers (generic)" name="ulcers" label="Ulcers"
                                    expression="$pt_has_htn or $pt_has_dbt"/>

                            <render concept="PIH:HERBAL TRADITIONAL MEDICATIONS" name="herbs"
                                    label="Used traditional herbs"
                                    expression="$pt_has_rf or $pt_has_lf"/>
                            <render concept="CIEL:162306" name="nsaids" label="Took NSAIDs"
                                    expression="$pt_has_rf or $pt_has_lf"/>
                            <render concept="PIH:Retention of Urine" name="urinary-retention" label="Urinary retention"
                                    expression="$pt_has_rf"/>
                            <render concept="PIH:FATIGUE" name="fatigue" label="Fatigue" expression="$pt_has_rf"/>
                            <render concept="PIH:NAUSEA" name="nausea" label="Nausea"
                                    expression="$pt_has_rf or $pt_has_lf"/>
                            <render concept="PIH:PRURITIS" name="pruritis" label="Pruritis"
                                    expression="$pt_has_rf or $pt_has_lf"/>
                            <render concept="CIEL:119866" name="confusion" label="Confusion"
                                    expression="$pt_has_rf or $pt_has_lf"/>
                            <render concept="CIEL:165193" name="facial-edema" label="Facial edema"
                                    expression="$pt_has_rf or $pt_has_lf"/>
                            <render concept="CIEL:460" name="body-edema" label="Body edema"
                                    expression="$pt_has_rf or $pt_has_hf"/>
                            <render concept="CIEL:159596" name="regular-diet" label="Regular diet"
                                    expression="$pt_has_rf"/>

                            <render concept="PIH:ASTHMA EXACERBATION" name="asthma-exacerbation"
                                    label="Asthma exacerbation"
                                    expression="$pt_has_asthma or $pt_has_copd"/>
                            <render concept="CIEL:127639" name="respiratory-distress" label="Respiratory distress"
                                    expression="$pt_has_asthma or $pt_has_copd"/>
                            <render concept="PIH:CYANOSIS" name="cyanosis" label="Cyanosis"
                                    expression="$pt_has_asthma or $pt_has_copd"/>
                            <render concept="PIH:COUGH" name="cough" label="Cough"
                                    expression="$pt_has_asthma or $pt_has_copd"/>
                            <render concept="PIH:WHEEZE" name="wheezing" label="Wheezing"
                                    expression="$pt_has_asthma or $pt_has_copd"/>
                            <render concept="PIH:Respiratory emergency action plan" name="resp-action-plan"
                                    label="Has respiratory emergency action plan"
                                    expression="$pt_has_asthma or $pt_has_copd"/>

                            <render concept="PIH:DEPRESSION" name="depression" label="Concerns of depression"
                                    expression="$pt_has_hf or $pt_has_lf"/>
                            <render concept="PIH:CRACKLES" name="crackles" label="Crackles" expression="$pt_has_hf"/>
                            <render concept="CIEL:140147" name="jvd-elevated" label="Elevated JVD"
                                    expression="$pt_has_hf"/>

                            <render concept="PIH:Paracetamol" name="paracetamol" label="Taking PCM"
                                    expression="$pt_has_lf"/>
                            <render concept="PIH:5960" name="dyspnea" label="Dyspnea" expression="$pt_has_lf"/>
                            <render concept="PIH:ASCITES" name="Ascites" label="Ascites"
                                    expression="$pt_has_lf or $pt_has_scd"/>
                            <render concept="CIEL:148276" name="Asterixis" label="Asterixis" expression="$pt_has_lf"/>

                            <render concept="PIH:Pain" name="pain" label="Pain" expression="$pt_has_scd"/>
                            <render concept="PIH:FEVER" name="fever" label="Fever" expression="$pt_has_scd"/>
                            <render concept="CIEL:164377" name="meds-side-effects" label="Any medication side effects"
                                    expression="$pt_has_scd"/>
                            <render concept="PIH:ICTERIC SCLERA" name="icteric-sclera" label="Icteric sclera"
                                    expression="$pt_has_scd"/>
                            <render concept="CIEL:112804" name="spleen-palpable" label="Spleen palpable"
                                    expression="$pt_has_scd"/>
                        </repeat>
                    </div>

                    <div>
                        <includeIf velocityTest="$pt_has_htn">
                            <span class="inline-45">
                                <obs conceptId="PIH:Type of hypertension diagnosis"
                                     labelCode="pih.ncd.htn.diagnosis.type"
                                     answerConceptIds="CIEL:140147, CIEL:160771, PIH:11941, PIH:11942, CIEL:160774, CIEL:160778, CIEL:161644"
                                     style="checkbox"/>
                            </span>
                        </includeIf>


                        <includeIf velocityTest="$pt_has_dbt">
                            <span class="inline-45">
                                <obs conceptId="PIH:Type of diabetes diagnosis"
                                     labelCode="pih.ncd.diabetes.diagnosis.type"
                                     answerConceptIds="CIEL:142474, CIEL:165207, CIEL:165208, CIEL:1449, CIEL:138291"
                                     answerLabels="Type 1 diabetes, Type 2 diabetes - insulin-dependent, Type 2 diabetes - non-insulin dependent, Gestational diabetes, Hyperglycemia"
                                     style="checkbox"/>
                            </span>
                        </includeIf>


                        <includeIf velocityTest="$pt_has_hf">
                            <span class="inline-45">
                                <obs conceptId="PIH:NYHA CLASS"
                                     labelCode="pihcore.ncd.hf.nyha.class"
                                     answerConceptIds="PIH:NYHA CLASS 1, PIH:NYHA CLASS 2, PIH:NYHA CLASS 3, PIH:NYHA CLASS 4"
                                     answerLabels="NYHA I, NYHA II, NYHA III, NYHA IV"
                                     style="checkbox"/>
                            </span>
                        </includeIf>


                        <includeIf velocityTest="$pt_has_rf">
                            <span class="inline-45">
                                <obs conceptId="CIEL:165570"
                                     labelCode="pihcore.ncd.ckd.stage"
                                     answerConceptIds="CIEL:120575,CIEL:120574,CIEL:120579,CIEL:120578,CIEL:120577"
                                     answerLabels="CKD I,CKD II,CKD III,CKD IV,CKD V"
                                     style="checkbox" answerSeparator=""/>
                            </span>
                        </includeIf>


                        <includeIf velocityTest="$pt_has_rf or $pt_has_scd">
                            <span class="inline-45">
                                <obs conceptId="PIH:CONJUNCTIVA"
                                     labelCode="pihcore.ncd.conjunctiva"
                                     answerConceptIds="PIH:NORMAL, PIH:PALE CONJUNCTIVA"
                                     style="checkbox"/>
                            </span>
                        </includeIf>


                        <includeIf velocityTest="$pt_has_scd">
                            <span class="inline-45">
                                <obs conceptId="CIEL:160689"
                                     labelCode="pihcore.ncd.lung.examination"
                                     style="textarea"/>
                            </span>
                        </includeIf>
                    </div>
                    <br/>

                    <div>
                        <table>
                            <tbody>
                                <repeat>
                                    <template>
                                        <includeIf velocityTest="{expression}">
                                            <tr>
                                                <obsgroup groupingConceptId="PIH:Radiology report construct">
                                                    <td style="width:35%">
                                                        <obs conceptId="PIH:Radiology procedure performed"
                                                             labelText="{procedure}"
                                                             answerLabel="" answerConceptId="{concept}"
                                                             toggle="{id: '{name}', style: 'dim'}"/>
                                                    </td>
                                                    <td>
                                                        <span id="{name}">
                                                            <span class="block;">
                                                                <label class="inline">
                                                                    Date:
                                                                </label>
                                                                <obs conceptId="PIH:12847" class="inline"/>
                                                            </span>
                                                            <span class="block;">
                                                                <label>
                                                                    Impression:
                                                                </label>
                                                                <obs conceptId="PIH:Radiology report comments"
                                                                     style="textarea"/>
                                                            </span>
                                                        </span>
                                                    </td>
                                                </obsgroup>
                                            </tr>
                                        </includeIf>
                                    </template>
                                    <render name="echocardiogram" procedure="Echocardiogram"
                                            concept="PIH:Transthoracic echocardiogram"
                                            expression="$pt_has_htn or $pt_has_dbt or $pt_has_hf"/>
                                    <render name="ultrasound" procedure="Ultrasound"
                                            concept="PIH:Abdomen retroperitoneum limited (US)"
                                            expression="$pt_has_rf or $pt_has_lf or $pt_has_scd"/>
                                </repeat>
                                <!-- Electrocardiogram construct -->
                                <includeIf velocityTest="$pt_has_htn or $pt_has_dbt or $pt_has_hf">
                                    <tr>
                                        <obsgroup groupingConceptId="PIH:ELECTROCARDIOGRAM CONSTRUCT">
                                            <td style="width: 35%">
                                                <label>
                                                    EKG Results
                                                </label>
                                            </td>
                                            <td>
                                                <span class="block;">
                                                    <label class="inline">
                                                        Date:
                                                    </label>
                                                    <obs conceptId="PIH:12847" class="inline"/>
                                                </span>
                                                <span class="block;">
                                                    <label>
                                                        Impression:
                                                    </label>
                                                    <obs conceptId="CIEL:159565" style="radio" class="inline block"
                                                         answerSeparator=""
                                                         answerConceptIds="CIEL:1115,CIEL:135971,CIEL:148203,CIEL:115432,CIEL:5622"/>
                                                </span>
                                                <span class="block;">
                                                    <label>
                                                        Comments:
                                                    </label>
                                                    <obs conceptId="CIEL:159395" style="textarea"/>
                                                </span>
                                            </td>
                                        </obsgroup>
                                    </tr>
                                </includeIf>
                            </tbody>
                        </table>
                    </div>

                    <div class="inline">
                        <h5>
                            <uimessage code="pihcore.ncd.presume.etiology.label"></uimessage>
                        </h5>
                        <includeIf velocityTest="$pt_has_rf">
                            <span class="inline-45">
                                <obs conceptId="PIH:NCD category" answerConceptId="PIH:HYPERTENSION" style="checkbox"/>
                            </span>
                            <span class="inline-45">
                                <obs conceptId="PIH:NCD category" answerConceptId="PIH:DIABETES" style="checkbox"/>
                            </span>
                            <span class="inline-45">
                                <obs conceptId="PIH:NCD category" answerConceptId="CIEL:165543" style="checkbox"/>
                            </span>
                            <span class="inline-45">
                                <obs conceptId="PIH:NCD category" answerConceptId="CIEL:138152" style="checkbox"/>
                            </span>
                            <span class="inline-45">
                                <obs conceptId="PIH:NCD category" answerConceptId="CIEL:153701" style="checkbox"/>
                            </span>
                            <span class="inline-45">
                                <obs conceptId="PIH:NCD category" answerConceptId="PIH:HEPATITIS B" style="checkbox"/>
                            </span>
                            <span class="inline-45">
                                <obs conceptId="PIH:NCD category" answerConceptId="PIH:HEPATITIS C" style="checkbox"/>
                            </span>
                            <span class="inline-45">
                                <obs conceptId="PIH:NCD category" answerConceptId="CIEL:113349" style="checkbox"/>
                            </span>
                            <span class="inline-45">
                                <obs conceptId="PIH:NCD category" answerConceptId="CIEL:119991" style="checkbox"/>
                            </span>
                            <span class="inline-45">
                                <obs conceptId="PIH:NCD category" answerConceptId="CIEL:115303" style="checkbox"/>
                            </span>
                        </includeIf>
                        <includeIf velocityTest="$pt_has_lf">
                            <span class="inline-45">
                                <obs conceptId="PIH:NCD category" answerConceptId="CIEL:70468" style="checkbox"/>
                            </span>
                            <span class="inline-45">
                                <obs conceptId="PIH:NCD category" answerConceptId="PIH:HEART DISEASE" style="checkbox"/>
                            </span>
                            <span class="inline-45">
                                <obs conceptId="PIH:NCD category" answerConceptId="CIEL:144223" style="checkbox"/>
                            </span>
                        </includeIf>
                        <includeIf velocityTest="$pt_has_scd">
                            <span class="inline-45">
                                <obs conceptId="PIH:NCD category" answerConceptId="PIH:123" style="checkbox"/>
                            </span>
                            <span class="inline-45">
                                <obs conceptId="PIH:NCD category" answerConceptId="PIH:11563" style="checkbox"/>
                            </span>
                            <span class="inline-45">
                                <obs conceptId="PIH:NCD category" answerConceptId="CIEL:117635" style="checkbox"/>
                            </span>
                        </includeIf>

                        <includeIf velocityTest="$pt_has_lf or $pt_has_scd">
                            <span class="inline-45">
                                <obs conceptId="PIH:NCD category" answerConceptId="PIH:Infectious Disease"
                                     style="checkbox"/>
                            </span>
                            <span class="inline-45">
                                <obs conceptId="PIH:NCD category" answerConceptId="CIEL:116031" style="checkbox"/>
                            </span>
                        </includeIf>

                        <includeIf velocityTest="$pt_has_rf or $pt_has_lf or $pt_has_scd">
                            <span class="inline-45">
                                <obs conceptId="PIH:NCD category" answerConceptId="PIH:Unknown" style="checkbox"/>
                            </span>
                            <span class="inline-45">
                                <obs conceptId="PIH:NCD category" answerConceptId="PIH:OTHER" style="checkbox"
                                     commentFieldLabel=""/>
                            </span>
                        </includeIf>

                    </div>
                </div>
            </section>
        </includeIf>

        <excludeIf
                velocityTest="$pt_has_htn or $pt_has_dbt or $pt_has_rf or $pt_has_asthma or $pt_has_copd or $pt_has_hf or $pt_has_lf or $pt_has_scd">
            <section sectionTag="fieldset" headerTag="legend" headerStyle="title"
                     headerCode="pihcore.ncd.title">
                <div class="section-container">
                    <strong>The patient does not have an active condition. Please add one on the conditions page.
                    </strong>
                </div>
            </section>
        </excludeIf>


        <!-- Medications section -->
        <section id="ncd-meds" sectionTag="fieldset" headerTag="legend" headerStyle="title"
                 headerCode="pihcore.visitNote.plan.medication">
            <div class="section-container toggle">
                <table>
                    <thead>
                        <tr>
                            <th>
                                <uimessage code="pihcore.visitNote.plan.name"/>
                            </th>
                            <th colspan="2">
                                <uimessage code="pihcore.visitNote.plan.dose"/>
                            </th>
                            <th>
                                <uimessage code="pihcore.drug.route"/>
                            </th>
                            <th>
                                <uimessage code="pihcore.visitNote.plan.frequency"/>
                            </th>
                            <th colspan="2">
                                <uimessage code="pihcore.visitNote.plan.duration"/>
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        <repeat with="['1'],['2'],['3'],['4'],['5'],['6'],['7']">
                            <tr id="medication-{0}" class="medication">
                                <obsgroup groupingConceptId="PIH:Prescription construct">
                                    <td id="{0}-rx">
                                        <obs id="{0}-rx-name" class="medication-name" conceptId="CIEL:1282"
                                             style="autocomplete" answerClasses="Drug"/>
                                    </td>
                                    <td id="{0}-rx-dose">
                                        <obs id="dose-{0}" class="doseInput" conceptId="CIEL:160856"/>
                                    </td>
                                    <td id="{0}-rx-dose-unit">
                                        <obs id="{0}-doseUnit" class="doseInput select-arrow"
                                             conceptId="PIH:Dosing units coded"
                                             answerConceptIds="CIEL:161553,CIEL:162263,CIEL:1608,CIEL:1513"
                                             answerCodes="pihcore.visitNote.plan.medication.units.mg,pihcore.visitNote.plan.medication.units.mL,pihcore.visitNote.plan.medication.units.capsule,pihcore.visitNote.plan.medication.units.tablet"/>
                                    </td>
                                    <td id="{name}-rx-route">
                                        <obs id="route-{name}" class="route select-arrow"
                                             conceptId="PIH:12651"
                                             answerConceptIds="CIEL:160240,CIEL:160242,CIEL:160243,CIEL:160245"
                                             answerLabels="Oral,IV,IM,SubQ"/>
                                    </td>
                                    <td id="{0}-rx-frequency">
                                        <obs id="{0}-frequencyCoded" class="frequency select-arrow"
                                             conceptId="CIEL:160855"
                                             answerConceptIds=
                                                     "PIH:OD,PIH:BID,PIH:TID,PIH:QID,PIH:PRN,PIH:STAT,PIH:OTHER"
                                             answerCodes="OD,BID,TID,QID,STAT,PRN,pihcore.visitNote.plan.other"/>
                                    </td>
                                    <td id="{name}-rx-duration">
                                        <obs id="duration-{name}" class="duration doseInput" conceptId="CIEL:159368"/>
                                    </td>
                                    <td id="{name}-rx-duration-unit">
                                        <obs id="durationUnit-{name}" class="duration-unit select-arrow"
                                             conceptId="PIH:TIME UNITS"
                                             answerConceptIds="CIEL:1822,CIEL:1072,CIEL:1073,CIEL:1074"/>
                                    </td>
                                </obsgroup>
                            </tr>
                        </repeat>
                    </tbody>
                </table>

                <div class="two-columns">
                    <p class="radio">
                        <label>
                            <uimessage code="pihcore.ncd.plan.missing_meds"/>
                        </label>
                        <obs conceptId="PIH:10555" style="radio"
                             answerConceptIds="PIH:YES,PIH:NO"
                             answerCodes="pihcore.meds.goodCompliance,pihcore.meds.poorCompliance"
                             answerSeparator=""/>
                    </p>
                    <div>
                        <label>
                            <uimessage code="pihcore.meds.reasonMissedMeds"/>
                        </label>
                        <obs conceptId="CIEL:160582"/>
                    </div>
                </div>

                <p>
                    <label>
                        <uimessage code="pihcore.exam.comment"/>:
                    </label>

                    <obs conceptId="PIH:Medication comments (text)" style="textarea"/>
                </p>

                <p class="list-inline">
                    <label>
                        <uimessage code="pihcore.medication.side.effects"/>
                    </label>

                    <obs id="med-side-effects" conceptId="CIEL:165273" answerConceptIds="PIH:YES,PIH:NO,PIH:UNKNOWN">
                        <controls>
                            <when value="PIH:YES" thenDisplay="#side-effect-section"/>
                        </controls>
                    </obs>
                </p>

                <p id="side-effect-section">
                    <obs id="" conceptId="CIEL:164377" style="textarea"/>
                </p>
            </div>
        </section>


        <section id="ncd_plan" sectionTag="fieldset" headerTag="legend" headerStyle="title"
                 headerCode="pihcore.visitNote.plan">
            <div class="section-container">

                <p>
                    <label>
                        <uimessage code="pihcore.comment"/>:
                    </label>
                    <obs conceptId="PIH:PATIENT PLAN COMMENTS" style="textarea" rows="10"/>
                </p>

                <p>
                    <label class="inline">
                        <uimessage code="pihcore.consult.returnVisitDate"/>:
                    </label>
                    <span class="small">
                        <obs id="return-visit-date" conceptId="PIH:RETURN VISIT DATE" allowFutureDates="true"
                             required="true"/>
                    </span>
                </p>


                <div class="two-columns">
                    <!-- this section is ONLY included for NCD followup encounter -->
                    <includeIf velocityTest="$encounter.encounterType.uuid == '5cbfd6a2-92d9-4ad0-b526-9d29bfe1d10c'">
                        <p class="radio">
                            <label>
                                <uimessage code="pihcore.ncd.plan.appt"/>
                            </label>
                            <obs conceptId="PIH:Appearance at appointment time" style="radio"
                                 answerConceptIds="PIH:YES,PIH:Between 1 and 7,PIH:More than 7"
                                 answerCodes="yes,pihcore.meds.late1to7Days,pihcore.meds.late7orMoreDays"
                                 answerSeparator=""/>
                        </p>
                    </includeIf>

                    <!-- this section is ONLY included for NCD followup encounter -->
                    <includeIf velocityTest="$encounter.encounterType.uuid == '5cbfd6a2-92d9-4ad0-b526-9d29bfe1d10c'">
                        <p class="radio">
                            <label>
                                <uimessage code="pihcore.ncd.plan.hospitalized"/>
                            </label>
                            <!-- ToDo: UHM-3919 Use hospitalization construct and migrate data -->
                            <obs conceptId="PIH:PATIENT HOSPITALIZED SINCE LAST VISIT"
                                 style="radio" answerConceptIds="PIH:YES,PIH:NO"
                                 answerCodes="yes,no" answerSeparator=""/>
                            <obs conceptId="CIEL:162879" labelCode="pihcore.reasonHospitalized"/>
                        </p>
                        <br/>
                        <br/>
                        <br/>
                        <br/>
                    </includeIf>
                </div>

            </div>
        </section>


        <ifMode mode="VIEW" include="false">
            <div id="buttons">
                <button id="submit" class="submitButton confirm right">
                    <uimessage code="mirebalais.save"/>
                    <i class="icon-spinner icon-spin icon-2x" style="display: none; margin-left: 10px;"></i>
                </button>
                <button id="cancel" type="button" class="cancel">
                    <uimessage code="emr.cancel"/>
                </button>
            </div>
        </ifMode>
    </div>

</htmlform>

